version: '3.8'

services:
  backend:
    build:
      context: ./java-spring-boot-backend
      dockerfile: Dockerfile
    container_name: highscores-backend
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-default}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:h2:mem:testdb}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-sa}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - highscores-network
    restart: unless-stopped

  go-backend:
    build:
      context: ./go-backend
      dockerfile: Dockerfile
    container_name: highscores-go-backend
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - DB_PATH=/app/data/highscores.db
      - GIN_MODE=release
    volumes:
      - go-backend-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - highscores-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: highscores-frontend
    ports:
      - "3000:80"
    environment:
      - BACKEND_URL=http://backend:8080
      - GO_BACKEND_URL=http://go-backend:8081
    depends_on:
      backend:
        condition: service_healthy
      go-backend:
        condition: service_healthy
    networks:
      - highscores-network
    restart: unless-stopped

networks:
  highscores-network:
    driver: bridge

volumes:
  go-backend-data:
